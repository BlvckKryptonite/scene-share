{% extends "base.html" %}
{% load extras %}
{% block content %}
<div class="container">

  <!-- Featured Movies Header -->
  <div class="movies-header">
    <h2>Featured Movies</h2>
  </div>

  <!-- Search Form -->
  <form method="GET" action="{% url 'movie_search' %}" class="search-form">
    <input type="text" name="q" placeholder="Search for a movie..." required />
    <button type="submit">Search</button>
  </form>

  <!-- Movie Grid -->
  <div class="movie-grid">
    {% for movie in movies %}
    <div class="movie-card">

      <!-- Poster -->
      {% if movie.poster %}
        <img src="{{ movie.poster.url }}" alt="{{ movie.title }} poster" class="movie-poster">
      {% elif movie.poster_path %}
        <img src="https://image.tmdb.org/t/p/w500{{ movie.poster_path }}" alt="{{ movie.title }} poster" class="movie-poster">
      {% else %}
        <div class="no-poster">No Poster</div>
      {% endif %}

      <!-- Movie Info -->
      <div class="movie-info">

        <!-- Title and Release Year Row -->
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h5 title="{{ movie.title }}">{{ movie.title }}</h5>
          {% if movie.release_year %}
            <span class="muted">({{ movie.release_year }})</span>
          {% elif movie.release_date %}
            <span class="muted">({{ movie.release_date|slice:":4" }})</span>
          {% endif %}
        </div>

        <!-- Movie Description -->
        {% if movie.description or movie.overview %}
          <p class="movie-description">{{ movie.description|default:movie.overview }}</p>
        {% endif %}

        <!-- Rating & Watchlist Inline -->
        <div class="rating-watchlist">
          {% if movie.avg_rating %}
            <span class="badge">⭐ {{ movie.avg_rating|floatformat:1 }}</span>
          {% endif %}

          {% if user.is_authenticated %}
            {% if movie.id in watchlist_movie_ids %}
              {% if movie.tmdb_id %}
                <a href="{% url 'remove_from_watchlist_tmdb' movie.tmdb_id %}" class="btn btn-danger">Remove</a>
                <a href="{% url 'movie_detail' movie.id %}" class="btn btn-secondary">Watchlist</a>
              {% else %}
                <a href="{% url 'remove_from_watchlist_local' movie.id %}" class="btn btn-danger">Remove</a>
                <a href="{% url 'movie_detail' movie.id %}" class="btn btn-secondary">Watchlist →</a>
              {% endif %}
            {% else %}
              {% if movie.tmdb_id %}
                <a href="{% url 'add_to_watchlist_tmdb' movie.tmdb_id %}" class="btn btn-primary">Add to Watchlist</a>
              {% else %}
                <a href="{% url 'add_to_watchlist_local' movie.id %}" class="btn btn-primary">Add to Watchlist</a>
              {% endif %}
            {% endif %}
          {% endif %}
        </div>

        <!-- Review Form -->
        {% if user.is_authenticated %}
        <form method="POST" class="review-form">
          {% csrf_token %}
          {% with form=forms_dict|get_item:movie.id %}

            <!-- Star Rating -->
            <div class="rating-group action-row">
              <label><strong>Rating:</strong></label>
              <div class="star-rating">
                {% for star_value in "54321" %}
                  <input type="radio" name="rating" id="star{{ movie.id }}-{{ star_value }}" value="{{ star_value }}" {% if form.rating.value|stringformat:"s" == star_value|stringformat:"s" %}checked{% endif %}/>
                  <label for="star{{ movie.id }}-{{ star_value }}">&#9733;</label>
                {% endfor %}
              </div>
            </div>

            <!-- Review Input Field Row -->
            <div class="review-input-row" style="margin-top: 0.5rem; margin-bottom: 0.5rem;">
              <input type="text" name="comment" placeholder="Write a review..." class="review-input" required style="flex:1; padding:0.5rem; border-radius:6px; border:1px solid #444; background:#2a2a2a; color:#fff;">
            </div>

            <!-- Post Review + Show Reviews Inline -->
            <div class="review-actions-row">
              <button type="submit" class="btn btn-primary btn-sm">Post Review</button>
              <button class="btn btn-secondary toggle-reviews" type="button" data-target="#reviews-{{ movie.id }}">Show Reviews</button>
            </div>

            <input type="hidden" name="movie_id" value="{{ movie.id }}">
          {% endwith %}
        </form>
        {% endif %}

<!-- Reviews List -->
<ul class="reviews-list" id="reviews-{{ movie.id }}">
  {% for review in movie.reviews.all %}
    <li>
      <!-- Comment + Rating -->
      <div class="review-comment">
        <strong style="color:var(--brand-yellow);">{{ review.user.username }}</strong>:
        <span style="color:#fff;">{{ review.comment }}</span><br>
        <span style="color:var(--accent);">
          {% for i in "12345" %}
            {% if forloop.counter <= review.rating %} ⭐ {% else %} ☆ {% endif %}
          {% endfor %}
        </span>
      </div>

      <!-- Footer: Like + Edit/Delete -->
      <div class="review-footer">
        <!-- Like Button -->
        <form class="like-form" data-review-id="{{ review.id }}">
          {% csrf_token %}
          <button type="button"
            class="like-btn{% if review.is_liked %} liked{% endif %}"
            title="{% if review.is_liked %}Unlike{% else %}Like this review{% endif %}"
            data-csrf="{{ csrf_token }}">
            <i class="{% if review.is_liked %}fa-solid{% else %}fa-regular{% endif %} fa-star"></i>
            <span class="like-text">{% if review.is_liked %}Liked{% else %}Like{% endif %}</span>
            <span class="like-count">{{ review.reviewlike_set.count }}</span>
          </button>
        </form>

        <!-- Edit/Delete Actions -->
        {% if user.is_authenticated and review.user == user %}
          <div class="review-actions">
            <a href="{% url 'edit_review' review.id %}" title="Edit">
              <i class="fa-solid fa-pen-to-square"></i>
            </a>
            <a href="{% url 'delete_review' review.id %}" title="Delete" onclick="return confirm('Are you sure?')">
              <i class="fa-solid fa-trash"></i>
            </a>
          </div>
        {% endif %}
      </div>
    </li>
  {% empty %}
    <li class="no-reviews">No reviews yet.</li>
  {% endfor %}
</ul>


      </div> <!-- end movie-info -->
    </div> <!-- end movie-card -->
    {% endfor %}
  </div> <!-- end movie-grid -->
</div> <!-- end container -->

<script>
// Toggle Reviews
document.querySelectorAll('.toggle-reviews').forEach(btn => {
  btn.addEventListener('click', () => {
    const list = document.querySelector(btn.dataset.target);
    list.classList.toggle('active');
    btn.textContent = list.classList.contains('active') ? 'Hide Reviews' : 'Show Reviews';
  });
});

// Read More / Show Less for movie descriptions (shows all text)
document.querySelectorAll('.movie-description').forEach(desc => {
  const fullText = desc.innerText;
  const maxLength = 120; // adjust length cutoff
  if (fullText.length > maxLength) {
    const shortText = fullText.slice(0, maxLength);
    desc.innerHTML = `
      <span class="short-text">${shortText}...</span>
      <span class="full-text" style="display:none;">${fullText}</span>
      <span class="read-more">Read More</span>
    `;
    const readMoreBtn = desc.querySelector('.read-more');
    readMoreBtn.addEventListener('click', () => {
      const shortTextSpan = desc.querySelector('.short-text');
      const fullTextSpan = desc.querySelector('.full-text');
      if (fullTextSpan.style.display === 'none') {
        shortTextSpan.style.display = 'none';
        fullTextSpan.style.display = 'inline';
        readMoreBtn.innerText = 'Show Less';
      } else {
        shortTextSpan.style.display = 'inline';
        fullTextSpan.style.display = 'none';
        readMoreBtn.innerText = 'Read More';
      }
    });
  }
});

// Review LIKE button AJAX script:
document.addEventListener('DOMContentLoaded', function() {
  const likeForms = document.querySelectorAll('.like-form');

  likeForms.forEach(form => {
    const button = form.querySelector('.like-btn');
    const reviewId = form.dataset.reviewId;
    const csrfToken = button.dataset.csrf;

    button.addEventListener('click', () => {
      fetch(`/community/like/${reviewId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) return;

        // Update button style
        if (data.liked) {
          button.classList.add('liked');
          button.querySelector('i').classList.replace('fa-regular', 'fa-solid');
          button.querySelector('.like-text').textContent = 'Liked';
        } else {
          button.classList.remove('liked');
          button.querySelector('i').classList.replace('fa-solid', 'fa-regular');
          button.querySelector('.like-text').textContent = 'Like';
        }

        // Update count
        button.querySelector('.like-count').textContent = data.like_count;
      })
      .catch(err => console.error(err));
    });
  });
});
</script>
{% endblock %}
</script>

